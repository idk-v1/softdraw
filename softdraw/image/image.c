#include "image.h"

#include <malloc.h>

uint64_t _sft_font_glyphs[95] =
{
    0b00011000'00011000'00100100'00111100'01000010'01000010'00000000'00000000, // A
    0b01111000'01000100'01111000'01000100'01000100'01111000'00000000'00000000, // B
    0b00111000'01000100'10000000'10000000'01000100'00111000'00000000'00000000, // C
    0b01111000'01000100'01000100'01000100'01000100'01111000'00000000'00000000, // D
    0b01111100'01000000'01111000'01000000'01000000'01111100'00000000'00000000, // E
    0b01111100'01000000'01111000'01000000'01000000'01000000'00000000'00000000, // F
    0b00111000'01000100'10000000'10011100'01000100'00111000'00000000'00000000, // G
    0b01000010'01000010'01111110'01000010'01000010'01000010'00000000'00000000, // H
    0b00111110'00001000'00001000'00001000'00001000'00111110'00000000'00000000, // I
    0b00011100'00000100'00000100'00000100'01000100'00111000'00000000'00000000, // J
    0b01000100'01001000'01010000'01110000'01001000'01000100'00000000'00000000, // K
    0b01000000'01000000'01000000'01000000'01000000'01111110'00000000'00000000, // L
    0b01000001'01100011'01010101'01001001'01000001'01000001'00000000'00000000, // M
    0b01000010'01100010'01010010'01001010'01000110'01000010'00000000'00000000, // N
    0b00011100'00100010'00100010'00100010'00100010'00011100'00000000'00000000, // O
    0b01111000'01000100'01111000'01000000'01000000'01000000'00000000'00000000, // P
    0b00011100'00100010'00100010'00100010'00100010'00011100'00000010'00000000, // Q
    0b01111000'01000100'01111000'01010000'01001000'01000100'00000000'00000000, // R
    0b00011100'00100010'00010000'00001100'00100010'00011100'00000000'00000000, // S
    0b01111111'00001000'00001000'00001000'00001000'00001000'00000000'00000000, // T
    0b01000010'01000010'01000010'01000010'01000010'00111100'00000000'00000000, // U
    0b10000001'01000010'01000010'00100100'00100100'00011000'00000000'00000000, // V
    0b01000001'01000001'01001001'01010101'01100011'01000001'00000000'00000000, // W
    0b01000010'00100100'00011000'00011000'00100100'01000010'00000000'00000000, // X
    0b01000001'00100010'00010100'00001000'00001000'00001000'00000000'00000000, // Y
    0b01111110'00000100'00001000'00010000'00100000'01111110'00000000'00000000, // Z

    0b00000000'00111100'00000010'00111110'01000110'00111010'00000000'00000000, // a
    0b01000000'01000000'01111100'01000010'01100010'01011100'00000000'00000000, // b
    0b00000000'00000000'00011100'00100000'00100000'00011100'00000000'00000000, // c
    0b00000010'00000010'00111110'01000010'01000110'00111010'00000000'00000000, // d
    0b00000000'00111100'01000010'01111110'01000000'00111100'00000000'00000000, // e
    0b00000000'00011000'00010000'00111000'00010000'00010000'00000000'00000000, // f
    0b00000000'00000000'00110100'01001100'01000100'00110100'00000100'00111000, // g
    0b00100000'00100000'00111000'00100100'00100100'00100100'00000000'00000000, // h
    0b00001000'00000000'00001000'00001000'00001000'00001000'00000000'00000000, // i
    0b00001000'00000000'00011000'00001000'00001000'00001000'00001000'01110000, // j
    0b00100000'00100000'00100100'00101000'00110000'00101100'00000000'00000000, // k
    0b00010000'00010000'00010000'00010000'00010000'00011000'00000000'00000000, // l
    0b00000000'00000000'01100110'01011010'01000010'01000010'00000000'00000000, // m
    0b00000000'00000000'00101110'00110010'00100010'00100010'00000000'00000000, // n
    0b00000000'00000000'00111100'01000010'01000010'00111100'00000000'00000000, // o
    0b00000000'00000000'01011100'01100010'01000010'01111100'01000000'01000000, // p
    0b00000000'00000000'00111010'01000110'01000010'00111110'00000010'00000010, // q
    0b00000000'00000000'00101100'00110010'00100000'00100000'00000000'00000000, // r
    0b00000000'00011100'00100000'00011000'00000100'00111000'00000000'00000000, // s
    0b00000000'00010000'00111100'00010000'00010000'00011000'00000000'00000000, // t
    0b00000000'00000000'00100010'00100010'00100110'00011010'00000000'00000000, // u
    0b00000000'00000000'01000010'01000010'00100100'00011000'00000000'00000000, // v
    0b00000000'00000000'10000001'10000001'01011010'01100110'00000000'00000000, // w
    0b00000000'00000000'01000010'00100100'00011000'01100110'00000000'00000000, // x
    0b00000000'00000000'01000010'00100010'00010100'00001000'00010000'01100000, // y
    0b00000000'00000000'00111100'00001000'00010000'00111100'00000000'00000000, // z

    0b00011000'00100100'01000010'01000010'00100100'00011000'00000000'00000000, // 0
    0b00001000'00011000'00001000'00001000'00001000'00011100'00000000'00000000, // 1
    0b00111100'01000010'00000100'00011000'00100000'01111110'00000000'00000000, // 2
    0b00111100'01000010'00000100'00011000'01000010'00111100'00000000'00000000, // 3
    0b00001000'00011000'00101000'01001000'01111100'00001000'00000000'00000000, // 4
    0b01111110'01000000'01111100'00000010'01000010'00111100'00000000'00000000, // 5
    0b00111100'01000000'01111100'01000010'01000010'00111100'00000000'00000000, // 6
    0b01111110'00000100'00001000'00010000'00100000'01000000'00000000'00000000, // 7
    0b00111100'01000010'00111100'01000010'01000010'00111100'00000000'00000000, // 8
    0b00111100'01000010'01000010'00111110'00000010'00111100'00000000'00000000, // 9

    0b00000000'00000000'00000000'00000000'00000000'00000000'00000000'00000000, // 
    0b00001000'00001000'00001000'00001000'00000000'00001000'00000000'00000000, // !
    0b00101000'00101000'00000000'00000000'00000000'00000000'00000000'00000000, // "
    0b00000000'00101000'01111100'00101000'01111100'00101000'00000000'00000000, // #
    0b00001000'00011110'00101000'00011100'00001010'00111100'00001000'00000000, // $
    0b01100000'10010100'01101000'00010110'00101001'00000110'00000000'00000000, // %
    0b00011100'00100000'00100000'00011001'00100110'00011001'00000000'00000000, // &
    0b00001000'00001000'00000000'00000000'00000000'00000000'00000000'00000000, // '
    0b00001000'00010000'00100000'00100000'00010000'00001000'00000000'00000000, // (
    0b00010000'00001000'00000100'00000100'00001000'00010000'00000000'00000000, // )
    0b00101010'00011100'00111110'00011100'00101010'00000000'00000000'00000000, // *
    0b00000000'00001000'00001000'00111110'00001000'00001000'00000000'00000000, // +
    0b00000000'00000000'00000000'00000000'00000000'00001000'00010000'00000000, // ,
    0b00000000'00000000'00000000'00111100'00000000'00000000'00000000'00000000, // -
    0b00000000'00000000'00000000'00000000'00000000'00001000'00000000'00000000, // .
    0b00000010'00000100'00001000'00010000'00100000'01000000'00000000'00000000, // /
    0b00000000'00000000'00001000'00000000'00000000'00001000'00000000'00000000, // :
    0b00000000'00000000'00001000'00000000'00000000'00001000'00010000'00000000, // ;
    0b00000000'00000110'00011000'01100000'00011000'00000110'00000000'00000000, // <
    0b00000000'00000000'01111110'00000000'01111110'00000000'00000000'00000000, // =
    0b00000000'01100000'00011000'00000110'00011000'01100000'00000000'00000000, // >
    0b00111000'01000100'00000100'00011000'00000000'00010000'00000000'00000000, // ?
    0b00000000'00111100'01000100'10011100'10010100'01011100'00100000'00011100, // @
    0b00111000'00100000'00100000'00100000'00100000'00111000'00000000'00000000, // [
    0b01000000'00100000'00010000'00001000'00000100'00000010'00000000'00000000, // \ 
    0b00111000'00001000'00001000'00001000'00001000'00111000'00000000'00000000, // ]
    0b00010000'00101000'00000000'00000000'00000000'00000000'00000000'00000000, // ^
    0b00000000'00000000'00000000'00000000'00000000'01111110'00000000'00000000, // _
    0b00010000'00001000'00000000'00000000'00000000'00000000'00000000'00000000, // `
    0b00011100'00010000'00110000'00110000'00010000'00011100'00000000'00000000, // {
    0b00001000'00001000'00001000'00001000'00001000'00001000'00001000'00000000, // |
    0b00111000'00001000'00001100'00001100'00001000'00111000'00000000'00000000, // }
    0b00000000'00000000'00000000'00110010'01001100'00000000'00000000'00000000, // ~
};

sft_image* sft_image_create(uint32_t width, uint32_t height)
{
    sft_image* image = malloc(sizeof(sft_image));
    if (image)
    {
        image->pixels = NULL;
        sft_image_resize(image, width, height);
        return image;
    }
    return NULL;
}

void sft_image_resize(sft_image* image, uint32_t width, uint32_t height)
{
    if (!image)
        return;

    if (image->width == width && image->height == height)
        return;

    if (width > 0 && height > 0)
    {
        if (image->pixels)
            free(image->pixels);
        image->pixels = malloc(width * height * sizeof(sft_color));
    }
    image->width = width;
    image->height = height;
}

void sft_image_fill(sft_image* image, sft_color color)
{
    if (!image || !image->pixels)
        return;

    for (uint64_t i = 0; i < image->width * image->height; i++)
        image->pixels[i] = color;
}

void sft_image_delete(sft_image* image)
{
    if (!image)
        return;

    if (image->pixels)
        free(image->pixels);
    free(image);
}

void sft_image_drawImage(sft_image* dest, const sft_image* src,
    int32_t srcX, int32_t srcY, uint32_t srcW, uint32_t srcH, 
    int32_t destX, int32_t destY) 
{
    if (!dest || !src || !dest->pixels || !src->pixels)
        return;

    _sft_image_adjustRect(&srcX, &srcY, &srcW, &srcH, src->width, src->height);
    _sft_image_adjustRect(&destX, &destY, &srcW, &srcH, dest->width, dest->height);

    for (uint64_t y = 0; y < srcH; y++)
        for (uint64_t x = 0; x < srcW; x++)
            dest->pixels[(x + destX) + (y + destY) * dest->width] = 
            src->pixels[(x + srcX) + (y + srcY) * src->width];
}

void sft_image_drawRect(sft_image* dest, int32_t x, int32_t y, uint32_t w, uint32_t h, sft_color color)
{
    if (!dest || !dest->pixels)
        return;

    _sft_image_adjustRect(&x, &y, &w, &h, dest->width, dest->height);

    for (uint64_t yy = 0; yy < h; yy++)
        for (uint64_t xx = 0; xx < w; xx++)
            dest->pixels[(xx + x) + (yy + y) * dest->width] = color;
}

void _sft_image_adjustRect(int32_t* x, int32_t* y, uint32_t* w, uint32_t* h, 
    uint64_t width, uint64_t height)
{
    if (*x < 0)
    {
        *w -= sft_min(sft_abs(*x), *w);
        *x = 0;
    }
    if (*y < 0)
    {
        *h -= sft_min(sft_abs(*y), *h);
        *y = 0;
    }
    if (*x + *w >= width)
        *w = width - sft_min(*x, width);
    if (*y + *h >= height)
        *h = height - sft_min(*y, height);
}
